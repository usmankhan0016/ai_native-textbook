{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "RAG Retrieval Validation Response Schema",
  "description": "Schema for search_chunks() response from backend.retrieval",
  "type": "object",
  "required": ["query", "top_k", "results", "total_results", "validation", "timestamp", "duration_ms"],
  "properties": {
    "query": {
      "type": "string",
      "description": "Original user query",
      "minLength": 1,
      "maxLength": 1000
    },
    "top_k": {
      "type": "integer",
      "description": "Number of results requested",
      "minimum": 1,
      "maximum": 100
    },
    "results": {
      "type": "array",
      "description": "Ranked search results (0 to top_k items)",
      "maxItems": 100,
      "items": {
        "type": "object",
        "required": ["rank", "chunk_id", "text", "relevance_score", "source_url", "chapter", "book_id", "latency_ms"],
        "properties": {
          "rank": {
            "type": "integer",
            "description": "Position in result set (1-indexed)",
            "minimum": 1
          },
          "chunk_id": {
            "type": "string",
            "description": "Unique chunk identifier",
            "pattern": "^[a-f0-9]{32}#\\d{4}$"
          },
          "text": {
            "type": "string",
            "description": "Chunk content (snippet, optionally truncated)",
            "minLength": 10
          },
          "relevance_score": {
            "type": "number",
            "description": "Cosine similarity score",
            "minimum": 0,
            "maximum": 1
          },
          "source_url": {
            "type": "string",
            "description": "Original Docusaurus page URL",
            "format": "uri",
            "pattern": "^https://usmankhan0016\\.github\\.io/ai_native-textbook/"
          },
          "chapter": {
            "type": "string",
            "description": "Chapter or module designation",
            "minLength": 5
          },
          "section": {
            "type": "string",
            "description": "Section header (optional)",
            "minLength": 0
          },
          "book_id": {
            "type": "string",
            "description": "Textbook identifier",
            "enum": ["ai-native-textbook"]
          },
          "latency_ms": {
            "type": "integer",
            "description": "Query execution time in milliseconds",
            "minimum": 0
          }
        }
      }
    },
    "total_results": {
      "type": "integer",
      "description": "Total documents in collection",
      "minimum": 0
    },
    "validation": {
      "type": "object",
      "description": "Accuracy and quality checks",
      "required": ["all_metadata_valid", "scores_monotonic"],
      "properties": {
        "all_metadata_valid": {
          "type": "boolean",
          "description": "All results have non-null required metadata fields"
        },
        "scores_monotonic": {
          "type": "boolean",
          "description": "Relevance scores decrease monotonically by rank"
        },
        "expected_module_found": {
          "type": "boolean",
          "description": "Expected chapter found in top-3 results (if applicable)",
          "default": null
        },
        "latency_acceptable": {
          "type": "boolean",
          "description": "Max latency < 500ms",
          "default": true
        }
      }
    },
    "timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp of query execution",
      "format": "date-time"
    },
    "duration_ms": {
      "type": "integer",
      "description": "Total round-trip latency (including Cohere + Qdrant)",
      "minimum": 0
    }
  },
  "examples": [
    {
      "query": "What is ROS 2?",
      "top_k": 5,
      "results": [
        {
          "rank": 1,
          "chunk_id": "34af8123eabc3065#0001",
          "text": "ROS 2 is a middleware for distributed robotics systems that enables communication...",
          "relevance_score": 0.92,
          "source_url": "https://usmankhan0016.github.io/ai_native-textbook/docs/module-1/chapter-1-introduction-to-ros2",
          "chapter": "Chapter 1: Introduction to ROS 2",
          "section": "What is ROS 2?",
          "book_id": "ai-native-textbook",
          "latency_ms": 145
        },
        {
          "rank": 2,
          "chunk_id": "5bfd28e99b44a67d#0001",
          "text": "The ROS 2 ecosystem includes publish-subscribe messaging, service calls, and actions...",
          "relevance_score": 0.87,
          "source_url": "https://usmankhan0016.github.io/ai_native-textbook/docs/module-1/chapter-2-nodes-and-topics",
          "chapter": "Chapter 2: Nodes and Topics",
          "section": "ROS 2 Communication Patterns",
          "book_id": "ai-native-textbook",
          "latency_ms": 142
        },
        {
          "rank": 3,
          "chunk_id": "16e391fb8ec63b9a#0002",
          "text": "ROS 2 differs from ROS 1 in its use of DDS (Data Distribution Service) for distribution...",
          "relevance_score": 0.81,
          "source_url": "https://usmankhan0016.github.io/ai_native-textbook/docs/module-1/chapter-1-introduction-to-ros2",
          "chapter": "Chapter 1: Introduction to ROS 2",
          "section": "ROS 2 vs ROS 1",
          "book_id": "ai-native-textbook",
          "latency_ms": 148
        }
      ],
      "total_results": 36,
      "validation": {
        "all_metadata_valid": true,
        "scores_monotonic": true,
        "expected_module_found": true,
        "latency_acceptable": true
      },
      "timestamp": "2025-12-20T18:40:38Z",
      "duration_ms": 153
    },
    {
      "query": "Quantum computing in robotics",
      "top_k": 5,
      "results": [],
      "total_results": 36,
      "validation": {
        "all_metadata_valid": true,
        "scores_monotonic": true,
        "expected_module_found": false,
        "latency_acceptable": true
      },
      "timestamp": "2025-12-20T18:41:05Z",
      "duration_ms": 98
    }
  ]
}
